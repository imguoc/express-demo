<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://unpkg.com/animate.css@3.7.0/animate.css">
    <title>Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        ul, ol {
            list-style: none;
        }
        .search form {
            text-align: right;
        }
        .search .name {
            height: 19px;
            padding: 0 5px;
            border: 1px solid #999;
            vertical-align: middle;
        }
        .search button {
            vertical-align: middle;
        }
        .list {
            width: 600px;
            margin: 20px auto;
        }
        .list h5 {
            font-size: 18px;
            color: #333;
            text-align: center;
        }
        .search form {
            margin: 10px auto;
        }
        .list .table {

        }
        .table table,
        .table table tr th,
        .table table tr td {
            border:1px solid #999;
        }
        .table table {
            width: 100%;
            border-collapse: collapse;
        }
        .table thead th {
            font-size: 14px;
            font-weight: normal;
            color: #fff;
            background: #999;
            height: 30px;
        }
        .table tbody td {
            font-size: 14px;
            color: #666;
            height: 48px;
        }
        .table tbody tr:nth-child(even) {
            background: #f6f6f6;
        }
        .table .placeholder {
            height: 100px;
            line-height: 80px;
            font-size: 14px;
            color: #999;
            text-align: center;
            border: 1px solid #999;
            border-top: none;
        }
        .page {
            font-size: 14px;
            color: #333;
            text-align: center;
            margin: 5px auto;
        }
        .page a {
            color: #333;
            text-decoration: none;
        }
        .page a.disabled {
            color: #999;
        }
        .page span {
            margin: 0 5px;
        }
        .contextmenu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 70px;
            border-radius: 4px;
            overflow: hidden;
        }
        .contextmenu .head {
            font-size: 12px;
            height: 24px;
            line-height: 24px;
            background: #c6c5c5;
            text-align: center;
        }
        .contextmenu ul {
            background: #e5e5e5;
            border-bottom: 6px solid #c6c5c5;
        }
        .contextmenu li {
            text-align: right;
            height: 30px;
            line-height: 30px;
            padding: 0 10px;
            border-top: 1px solid #c6c5c5;
        }
        .contextmenu li:hover {
            background: #b5b5b5;
        }
        .contextmenu li:first-child {
            border-top: none;
        }
        .contextmenu li span {
            font-size: 14px;
            vertical-align: middle;
            cursor: pointer;
         }

        .contextmenu li i {
            font-size: 26px;
            font-style: normal;
            vertical-align: middle;
            margin-right: 5px;
        }
        .dialog {
            display: none;
            background: rgba(0, 0, 0, 0.4);
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        .dialog .dialog-box {
            width: 400px;
            height: 250px;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
        }
        .dialog .head {
            background: #666;
            text-align: center;
            color: #fff;
            height: 30px;
            line-height: 30px;
        }
        .dialog .body form {
            text-align: center;
            margin: 25px auto;
        }
        .dialog .form-item {
            margin: 12px auto;
        }
        .dialog .form-item span {
            width: 100px;
            text-align: left;
            display: inline-block;
        }
        .dialog .foot {
            text-align: center;
            border-top: 1px solid #dcdcdc;
            line-height: 42px;
        }
        .dialog .foot button {
            margin: 0 8px;
        }
    </style>
</head>
<body>

    <div class="list">
        <h5>TEST Table</h5>
        <div class="search">
            <form onsubmit="return false" autocomplete="off">
                <input id="name" class="name" type="text" placeholder="search name">
                <button id="search">搜索</button>
                <button id="create">新建</button>
            </form>
        </div>
        <div id="table" class="table">
            <table cellpadding="0" cellspacing="0">
                <colgroup width="80px"></colgroup>
                <colgroup width="160px"></colgroup>
                <colgroup width="auto"></colgroup>
                <colgroup width="auto"></colgroup>
                <thead align="center">
                    <th>ID</th>
                    <th>NAME</th>
                    <th>CreateDate</th>
                    <th>UpdateDate</th>
                </thead>
                <tbody></tbody>
            </table>
            <div class="placeholder"></div>
        </div>
        <div id="page" class="page flex-box"></div>
    </div>

    <div id="contextmenu" class="contextmenu">
        <div class="head">功能</div>
        <ul>
            <li id="edit"><i>◎</i><span>编辑</span></li>
            <li id="delete"><i>◎</i><span>删除</span></li>
        </ul>
    </div>

    <div id="dialog" class="dialog">
        <div class="dialog-box">
                <div class="head">
                    编辑
                </div>
                <div class="body">
                    <form action="">
                        <div class="form-item">
                            <label>
                                <span>ID</span>:
                                <input type="text" id="formId" disabled>
                            </label>
                        </div>
                        <div class="form-item">
                            <label>
                                <span>NAME</span>:
                                <input type="text" id="formName">
                            </label>
                        </div>
                        <div class="form-item">
                            <label>
                                <span>CreateDate</span>:
                                <input type="text" id="formCreateDate" disabled>
                            </label>
                        </div>
                        <div class="form-item">
                            <label>
                                <span>UpdateDate</span>:
                                <input type="text" id="formUpdateDate" disabled>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="foot">
                    <button id="cancel" class="cancel">取消</button>
                    <button id="save" class="save">保存</button>
                </div>
        </div>
    </div>

    <script id="TempTable" type="text/html">
        {{ each }}
        <tr align="center">
            <td class="animated fadeInUp faster" style="animation-delay: 0.{{ $index }}s" data-key="id" data-value="{{ $value.id }}">{{ $value.id }}</td>
            <td class="animated fadeInUp faster" style="animation-delay: 0.{{ $index }}s" data-key="name" data-value="{{ $value.name }}">{{ $value.name }}</td>
            <td class="animated fadeInUp faster" style="animation-delay: 0.{{ $index }}s" data-key="createDate" data-value="{{ $value.createDate }}">{{ $value.createDate | dateFormat }}</td>
            <td class="animated fadeInUp faster" style="animation-delay: 0.{{ $index }}s" data-key="updateDate" data-value="{{ $value.updateDate }}">{{ $value.updateDate | dateFormat }}</td>
        </tr>
        {{ /each }}
    </script>

    <script id="TempPage" type="text/html">
        {{ if pageIndex > 1}}
            <a id="prev" class="prev" href="">上一页</a>
        {{ else }}
            <a class="prev disabled" href="javascript:;">上一页</a>
        {{ /if }}
        {{ if pageIndex < pageTotal}}
            <a id="next" class="next" href="">下一页</a>
        {{ else }}
            <a class="next disabled" href="javascript:;">下一页</a>
        {{ /if }}
        <span id="currentPage">
            第
            <select id="pageSelect">
            <% for(var i = 1; i <= pageTotal; i++){ %>
                <option value="<%= i %>"><%= i %></option>
            <% } %>
            </select>
            页
        </span>
        <span id="totalPage">共 {{ pageTotal }} 页</span>
    </script>

    <script src="https://unpkg.com/jquery@3.4.0/dist/jquery.js"></script>
    <script src="https://unpkg.com/moment@2.24.0/moment.js"></script>
    <script src="https://unpkg.com/art-template@4.13.2/lib/template-web.js"></script>

    <script>

        var pageIndex = 1;
        var pageSize = 5;
        var pageTotal = 0;

        $(function() {

            init()
            bindEvent()
            getQuery()

        })

        function init() {
            template.defaults.imports.dateFormat = function(data) {
                return moment(data).format('YYYY-MM-DD HH:mm:ss')
            }
            if (!localStorage.getItem('pageIndex')) {
                localStorage.setItem('pageIndex', pageIndex);
            } else {
                pageIndex = localStorage.getItem('pageIndex');
            }
        }

        function bindEvent() {

            $("#search").on("click", function() {
                var name = $("#name").val().trim()
                getQuery(name);
            })

            $(document).on("click", '#prev', function() {
                pageIndex = Number(localStorage.getItem('pageIndex')) - 1;
                getQuery();
                return false
            })

            $(document).on("click", '#next', function() {
                pageIndex = Number(localStorage.getItem('pageIndex')) + 1;
                getQuery();
                return false
            })

            $(document).on('change', '#pageSelect', function() {
                pageIndex = $('#pageSelect').val();
                getQuery();
            })

            $('#table').on('contextmenu', 'tbody tr', function(e) {
                var rowObj = {};
                Array.prototype.slice.apply(e.currentTarget.children).forEach(function(v, i) {
                    rowObj[v.dataset.key] = v.dataset.value
                })
                if ($('#contextmenu').is(':visible')) {
                    $('#contextmenu').stop(true, true).animate({top: e.pageY, left: e.pageX}, 200)
                } else {
                    $('#contextmenu').show()
                        .addClass('animated slideInRight faster')
                        .on('animationend', function() {
                            $(this).off('animationend').removeClass('animated slideInRight faster');
                        })
                        .css({
                            top: e.pageY,
                            left: e.pageX,
                        })
                }
                $('#edit').off('click').on('click', function() {
                    $('#dialog .head').text('编辑');
                    $('#dialog').attr('data-type', 'edit');
                    $('#dialog').show()
                        .find('.dialog-box')
                        .addClass('animated zoomInLeft')
                        .on('animationend', function() {
                            $(this).off('animationend').removeClass('animated zoomInLeft');
                        });
                    $('#formId').val(rowObj.id);
                    $('#formName').val(rowObj.name);
                    $('#formCreateDate').val(moment(rowObj.createDate).format('YYYY-MM-DD HH:mm:ss'));
                    $('#formUpdateDate').val(moment(rowObj.updateDate).format('YYYY-MM-DD HH:mm:ss'));
                })
                $('#delete').off('click').on('click', function() {
                    deleteRow(rowObj.id);
                    $('#contextmenu').fadeOut();
                })
                $('#contextmenu').off('mouseleave').on('mouseleave', function() {
                    $('#contextmenu').fadeOut();
                })
                return false
            })

            $(document).on("click", function(event) {
                if ($(event.target).closest('#contextmenu')[0]) {
                    $('#contextmenu').show();
                } else {
                    $('#contextmenu').fadeOut();
                }
            })

            $('#save').on("click", function(event) {
                if ($('#dialog').attr('data-type') === 'create') {
                    create();
                }
                if ($('#dialog').attr('data-type') === 'edit') {
                    update();
                }
            })

            $('#cancel').on("click", function(event) {
                $('#dialog').find('.dialog-box')
                    .addClass('animated zoomOutRight')
                    .on('animationend', function() {
                        $('#dialog').hide();
                        $(this).off('animationend').removeClass('animated zoomOutRight');
                    })
            })

            $('#create').on("click", function(event) {
                $('#dialog .head').text('新建');
                $('#dialog').attr('data-type', 'create');
                $('#dialog')
                    .show()
                    .find('.dialog-box')
                    .addClass('animated zoomInLeft')
                    .on('animationend', function() {
                        $(this).off('animationend').removeClass('animated zoomInLeft');
                    });
                $('#formId').val('');
                $('#formName').val('');
                $('#formCreateDate').val(moment().format('YYYY-MM-DD HH:mm:ss'));
                $('#formUpdateDate').val('');
        })

        }

        function getQuery(name) {
            $("#table tbody, #page").empty();
            $('#table .placeholder').show().text('正在加载');
            $.ajax({
                url: '/query',
                type: 'GET',
                data: {
                    name: name || '',
                    pageIndex: pageIndex || 1,
                    pageSize: pageSize || 5
                },
                dataType: 'json',
                success: function(data) {
                    if (data && data.data && data.data.length) {
                        var tableBody = template('TempTable', data.data);
                        $("#table tbody").html(tableBody);
                        var pageHtml = template('TempPage', data.pageInfo);
                        $('#page').html(pageHtml);
                        $('#table .placeholder').hide();
                    } else {
                        $('#table .placeholder').text('暂无数据');
                    }
                    localStorage.setItem('pageIndex', data.pageInfo.pageIndex);
                    $('#pageSelect').val(data.pageInfo.pageIndex);
                    pageTotal = data.pageInfo.pageTotal

                },
                error: function(err) {
                    $('#table .placeholder').text('加载错误');
                }
            })
        }

        function create(data) {
            $.ajax({
                url: '/create',
                type: 'GET',
                data: {
                    name: $('#formName').val()
                },
                dataType: 'json',
                success: function(data) {
                    $('#dialog').find('.dialog-box')
                        .addClass('animated zoomOutRight')
                        .on('animationend', function() {
                            $('#dialog').hide();
                            $(this).off('animationend').removeClass('animated zoomOutRight');
                            getQuery();
                        });
                }
            })
        }

        function update() {
            $.ajax({
                url: '/update',
                type: 'GET',
                data: {
                    id: $('#formId').val(),
                    name: $('#formName').val()
                },
                dataType: 'json',
                success: function(data) {
                    $('#dialog').find('.dialog-box')
                    .addClass('animated zoomOutRight')
                    .on('animationend', function() {
                        $('#dialog').hide();
                        $(this).off('animationend').removeClass('animated zoomOutRight');
                        getQuery();
                    });
                }
            })
        }

        function deleteRow(id) {
            $.ajax({
                url: '/delete',
                type: 'GET',
                data: {
                    id: id,
                },
                dataType: 'json',
                success: function(data) {
                    getQuery();
                }
            })
        }

    </script>
</body>
</html>
